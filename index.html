<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Local Lens â€“ Live Map</title>
  
  <!-- Leaflet map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <style>
    :root {
      --bg: #0b0f14;
      --card: #121823;
      --accent: #4a90e2;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: #fff;
    }
    h2 {
      margin: 12px;
    }
    #map {
      height: 55vh;
    }
    .controls, .post {
      background: var(--card);
      padding: 12px;
      margin: 10px;
      border-radius: 6px;
    }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 4px;
      border: none;
    }
  </style>
</head>
<body>
  <h2>Local Lens</h2>
  <div id="map"></div>

  <div class="controls">
    <button onclick="loadAlerts()">Refresh Alerts</button>
    <div id="alerts"></div>
  </div>

  <div class="post">
    <h3>Post an alert</h3>
    <label>Type</label>
    <select id="alertType">
      <option value="Traffic">Traffic</option>
      <option value="Crowd">Crowd</option>
      <option value="Deals">Deals</option>
      <option value="Safety">Safety</option>
      <option value="Event">Event</option>
    </select>
    <label>Notes</label>
    <textarea id="alertNotes" rows="3"></textarea>
    <button onclick="postAlert()">Submit</button>
  </div>

  <script>
    // --- Supabase setup ---
    const supabaseUrl = "https://cpoehiouyljletdplikv.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwb2VoaW91eWxqbGV0ZHBsaWt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3Mjc4MzgsImV4cCI6MjA3NDMwMzgzOH0.0kapsPz1bsrIXlzwWzbIPfqnzBjdApIgdCgXNoNwDng";
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // --- Leaflet map ---
    const map = L.map('map').setView([39.5359, -76.3483], 12); // Center near Bel Air
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // --- Load alerts from Supabase ---
    async function loadAlerts() {
      document.getElementById("alerts").innerHTML = "Loading...";
      const { data, error } = await _supabase.from("alerts").select("*").order("created_at", { ascending: false }).limit(10);
      if (error) {
        document.getElementById("alerts").innerHTML = "Error loading alerts.";
        console.error(error);
        return;
      }
      if (data.length === 0) {
        document.getElementById("alerts").innerHTML = "No alerts yet.";
        return;
      }
      document.getElementById("alerts").innerHTML = data.map(a =>
        `<p><b>${a.type}</b>: ${a.notes} <br><small>${new Date(a.created_at).toLocaleString()}</small></p>`
      ).join("");
    }

    // --- Post a new alert ---
    async function postAlert() {
      const type = document.getElementById("alertType").value;
      const notes = document.getElementById("alertNotes").value;
      const { error } = await _supabase.from("alerts").insert([{ type, notes }]);
      if (error) {
        alert("Error posting alert");
        console.error(error);
      } else {
        alert("Alert posted!");
        loadAlerts();
      }
    }

    // Load alerts on start
    loadAlerts();
  </script>
</body>
</html>
